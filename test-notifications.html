<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test License Notifications</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .button {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            margin: 10px;
            font-size: 14px;
            font-weight: 600;
        }
        .button:hover {
            background: #5a6fd8;
        }
        .button.danger {
            background: #dc3545;
        }
        .button.danger:hover {
            background: #c82333;
        }
        .button.success {
            background: #28a745;
        }
        .button.success:hover {
            background: #218838;
        }
        .log {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 15px;
            margin: 15px 0;
            font-family: monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
        }
        .status {
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .status.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        h1 {
            color: #333;
            text-align: center;
        }
        .section {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #dee2e6;
            border-radius: 6px;
        }
        .section h3 {
            margin-top: 0;
            color: #495057;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîß License Notification Testing</h1>
        
        <div class="section">
            <h3>üìß Email Notification Tests</h3>
            <button class="button success" onclick="testBasicEmail()">Test Basic Email</button>
            <button class="button" onclick="testExpiryEmail()">Test Expiry Email</button>
            <button class="button danger" onclick="testUrgentExpiryEmail()">Test Urgent Expiry Email</button>
        </div>

        <div class="section">
            <h3>üîÑ System Tests</h3>
            <button class="button" onclick="checkLicenseSerials()">Check License Serials</button>
            <button class="button" onclick="checkUserAssignments()">Check User Assignments</button>
            <button class="button danger" onclick="forceExpiryReminders()">Force Expiry Reminders</button>
        </div>

        <div class="section">
            <h3>üìä Database Status</h3>
            <button class="button" onclick="checkDatabaseStatus()">Check Database Status</button>
            <button class="button" onclick="clearLog()">Clear Log</button>
        </div>

        <div id="status" class="status info">
            Ready to test notifications. Click any button above to start.
        </div>

        <div id="log" class="log">
            Test logs will appear here...
        </div>
    </div>


    <script type="module">
        // Import Supabase (you'll need to adjust the path based on your setup)
        import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';

        // Initialize Supabase - replace with your actual credentials
        const supabaseUrl = 'https://kioqpivshgtpacwklcho.supabase.co'; // Replace with your actual URL
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imtpb3FwaXZzaGd0cGFjd2tsY2hvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg1MjUyODgsImV4cCI6MjA3NDEwMTI4OH0.svofeF_4ER7AcqbWBWVORk7ejHcA9ZGQfVcOP47j8s8'; // Replace with your actual key
        const supabase = createClient(supabaseUrl, supabaseKey);

        // Logging function
        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.style.color = type === 'error' ? '#dc3545' : type === 'success' ? '#28a745' : '#333';
            logEntry.textContent = `[${timestamp}] ${message}`;
            logDiv.appendChild(logEntry);
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function updateStatus(message, type = 'info') {
            const statusDiv = document.getElementById('status');
            statusDiv.textContent = message;
            statusDiv.className = `status ${type}`;
        }

        // Test functions
        window.testBasicEmail = async function() {
            updateStatus('Testing basic email notification...', 'info');
            log('üß™ Starting basic email test...');
            
            try {
                const testNotification = {
                    type: 'info',
                    title: 'Test Email Notification',
                    message: 'This is a test email from the License Management System.',
                    user_id: 'test-user',
                    is_read: false,
                    priority: 'medium',
                    action_required: false,
                    action_url: null,
                    created_at: new Date().toISOString(),
                    expires_at: null,
                };

                const { data, error } = await supabase.functions.invoke(
                    'send-email-notification',
                    {
                        body: {
                            to: 'ayezinhtun9@gmail.com',
                            subject: testNotification.title,
                            html: `
                                <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto; background: #f8f9fa;">
                                    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 30px 20px; text-align: center;">
                                        <h1 style="color: white; margin: 0; font-size: 24px; font-weight: 600;">License Management System</h1>
                                        <p style="color: rgba(255,255,255,0.9); margin: 5px 0 0 0; font-size: 14px;">One Cloud Technology</p>
                                    </div>
                                    <div style="padding: 30px 20px; background: white; margin: 0 20px;">
                                        <h2 style="color: #333; margin: 0 0 20px 0; font-size: 22px; font-weight: 600;">${testNotification.title}</h2>
                                        <p style="color: #666; font-size: 16px; line-height: 1.6;">${testNotification.message}</p>
                                        <div style="background: #d4edda; border: 1px solid #c3e6cb; padding: 20px; border-radius: 8px; margin: 25px 0;">
                                            <h4 style="margin: 0 0 10px 0; color: #155724; font-size: 16px; font-weight: 600;">‚úÖ Test Result:</h4>
                                            <p style="margin: 0; color: #155724;">If you receive this email, the basic notification system is working correctly!</p>
                                        </div>
                                    </div>
                                    <div style="background: #343a40; color: white; padding: 25px 20px; text-align: center; margin: 0 20px;">
                                        <p style="margin: 0; font-size: 12px; color: #6c757d;">
                                            ¬© ${new Date().getFullYear()} One Cloud Technology. All rights reserved.
                                        </p>
                                    </div>
                                </div>
                            `
                        }
                    }
                );

                if (error) {
                    log(`‚ùå Email failed: ${error.message}`, 'error');
                    updateStatus('Email test failed', 'error');
                } else {
                    log('‚úÖ Basic email sent successfully!', 'success');
                    log(`Response: ${JSON.stringify(data)}`);
                    updateStatus('Basic email test completed successfully', 'success');
                }
            } catch (error) {
                log(`‚ùå Test failed: ${error.message}`, 'error');
                updateStatus('Test failed', 'error');
            }
        };

        window.testExpiryEmail = async function() {
            updateStatus('Testing expiry email notification...', 'info');
            log('üß™ Starting expiry email test...');
            
            try {
                const testNotification = {
                    type: 'expiry',
                    title: 'License Expiring Soon',
                    message: 'Microsoft Office 365 Enterprise E3 (MSO365-E3-2024-001) expires in 15 days.',
                    user_id: 'test-user',
                    is_read: false,
                    priority: 'medium',
                    action_required: true,
                    action_url: '/licenses/12345',
                    created_at: new Date().toISOString(),
                    expires_at: null,
                };

                const urgencyLevel = 'IMPORTANT';
                const urgencyColor = '#fd7e14';
                
                const { data, error } = await supabase.functions.invoke(
                    'send-email-notification',
                    {
                        body: {
                            to: 'ayezinhtun9@gmail.com',
                            subject: testNotification.title,
                            html: `
                                <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto; background: #f8f9fa;">
                                    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 30px 20px; text-align: center;">
                                        <h1 style="color: white; margin: 0; font-size: 24px; font-weight: 600;">License Management System</h1>
                                        <p style="color: rgba(255,255,255,0.9); margin: 5px 0 0 0; font-size: 14px;">One Cloud Technology</p>
                                    </div>
                                    <div style="background: ${urgencyColor}; color: white; padding: 15px 20px; text-align: center; font-weight: 600; font-size: 16px; text-transform: uppercase; letter-spacing: 1px;">
                                        ${urgencyLevel} - ACTION REQUIRED
                                    </div>
                                    <div style="padding: 30px 20px; background: white; margin: 0 20px;">
                                        <h2 style="color: #dc3545; margin: 0 0 20px 0; font-size: 22px; font-weight: 600;">
                                            ‚ö†Ô∏è ${testNotification.title}
                                        </h2>
                                        <p style="color: #666; font-size: 16px; line-height: 1.6; margin-bottom: 25px;">
                                            ${testNotification.message}
                                        </p>
                                        <div style="background: #f8d7da; border: 1px solid #f5c6cb; padding: 20px; border-radius: 8px; margin: 25px 0;">
                                            <h4 style="margin: 0 0 10px 0; color: #721c24; font-size: 16px; font-weight: 600;">üìã Action Required:</h4>
                                            <ul style="margin: 0; padding-left: 20px; color: #721c24;">
                                                <li>Review license details immediately</li>
                                                <li>Contact vendor for renewal options</li>
                                                <li>Update license information in system</li>
                                                <li>Notify relevant team members</li>
                                            </ul>
                                        </div>
                                    </div>
                                    <div style="background: #343a40; color: white; padding: 25px 20px; text-align: center; margin: 0 20px;">
                                        <p style="margin: 0; font-size: 12px; color: #6c757d;">
                                            ¬© ${new Date().getFullYear()} One Cloud Technology. All rights reserved.
                                        </p>
                                    </div>
                                </div>
                            `
                        }
                    }
                );

                if (error) {
                    log(`‚ùå Expiry email failed: ${error.message}`, 'error');
                    updateStatus('Expiry email test failed', 'error');
                } else {
                    log('‚úÖ Expiry email sent successfully!', 'success');
                    updateStatus('Expiry email test completed successfully', 'success');
                }
            } catch (error) {
                log(`‚ùå Test failed: ${error.message}`, 'error');
                updateStatus('Test failed', 'error');
            }
        };

        window.testUrgentExpiryEmail = async function() {
            updateStatus('Testing urgent expiry email notification...', 'info');
            log('üß™ Starting urgent expiry email test...');
            
            try {
                const testNotification = {
                    type: 'expiry',
                    title: 'URGENT: License Expiring Soon',
                    message: 'Adobe Creative Cloud All Apps (ACC-ALL-2024-002) expires in 3 days!',
                    user_id: 'test-user',
                    is_read: false,
                    priority: 'high',
                    action_required: true,
                    action_url: '/licenses/67890',
                    created_at: new Date().toISOString(),
                    expires_at: null,
                };

                const urgencyLevel = 'URGENT';
                const urgencyColor = '#dc3545';
                
                const { data, error } = await supabase.functions.invoke(
                    'send-email-notification',
                    {
                        body: {
                            to: 'ayezinhtun9@gmail.com',
                            subject: testNotification.title,
                            html: `
                                <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto; background: #f8f9fa;">
                                    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 30px 20px; text-align: center;">
                                        <h1 style="color: white; margin: 0; font-size: 24px; font-weight: 600;">License Management System</h1>
                                        <p style="color: rgba(255,255,255,0.9); margin: 5px 0 0 0; font-size: 14px;">One Cloud Technology</p>
                                    </div>
                                    <div style="background: ${urgencyColor}; color: white; padding: 15px 20px; text-align: center; font-weight: 600; font-size: 16px; text-transform: uppercase; letter-spacing: 1px;">
                                        ${urgencyLevel} - ACTION REQUIRED
                                    </div>
                                    <div style="padding: 30px 20px; background: white; margin: 0 20px;">
                                        <h2 style="color: #dc3545; margin: 0 0 20px 0; font-size: 22px; font-weight: 600;">
                                            ‚ö†Ô∏è ${testNotification.title}
                                        </h2>
                                        <p style="color: #666; font-size: 16px; line-height: 1.6; margin-bottom: 25px;">
                                            ${testNotification.message}
                                        </p>
                                        <div style="background: #f8d7da; border: 1px solid #f5c6cb; padding: 20px; border-radius: 8px; margin: 25px 0;">
                                            <h4 style="margin: 0 0 10px 0; color: #721c24; font-size: 16px; font-weight: 600;">üìã Action Required:</h4>
                                            <ul style="margin: 0; padding-left: 20px; color: #721c24;">
                                                <li>Review license details immediately</li>
                                                <li>Contact vendor for renewal options</li>
                                                <li>Update license information in system</li>
                                                <li>Notify relevant team members</li>
                                            </ul>
                                        </div>
                                    </div>
                                    <div style="background: #343a40; color: white; padding: 25px 20px; text-align: center; margin: 0 20px;">
                                        <p style="margin: 0; font-size: 12px; color: #6c757d;">
                                            ¬© ${new Date().getFullYear()} One Cloud Technology. All rights reserved.
                                        </p>
                                    </div>
                                </div>
                            `
                        }
                    }
                );

                if (error) {
                    log(`‚ùå Urgent expiry email failed: ${error.message}`, 'error');
                    updateStatus('Urgent expiry email test failed', 'error');
                } else {
                    log('‚úÖ Urgent expiry email sent successfully!', 'success');
                    updateStatus('Urgent expiry email test completed successfully', 'success');
                }
            } catch (error) {
                log(`‚ùå Test failed: ${error.message}`, 'error');
                updateStatus('Test failed', 'error');
            }
        };

        window.checkLicenseSerials = async function() {
            updateStatus('Checking license serials...', 'info');
            log('üîç Checking license serials...');
            
            try {
                const { data, error } = await supabase
                    .from('license_serials')
                    .select(`
                        *,
                        licenses!inner(
                            created_by, 
                            item_description, 
                            project_assign
                        )
                    `)
                    .limit(10);

                if (error) {
                    log(`‚ùå Error fetching serials: ${error.message}`, 'error');
                    updateStatus('Failed to fetch license serials', 'error');
                } else {
                    log(`‚úÖ Found ${data?.length || 0} license serials`, 'success');
                    data.forEach((serial, index) => {
                        log(`  ${index + 1}. ${serial.serial_or_contract} - ${serial.licenses.item_description}`);
                        log(`     Project: ${serial.licenses.project_assign}, End Date: ${serial.end_date}`);
                    });
                    updateStatus(`Found ${data?.length || 0} license serials`, 'success');
                }
            } catch (error) {
                log(`‚ùå Check failed: ${error.message}`, 'error');
                updateStatus('Check failed', 'error');
            }
        };

        window.checkUserAssignments = async function() {
            updateStatus('Checking user assignments...', 'info');
            log('üë• Checking user project assignments...');
            
            try {
                const { data, error } = await supabase
                    .from('user_project_assigns')
                    .select('*')
                    .limit(10);

                if (error) {
                    log(`‚ùå Error fetching assignments: ${error.message}`, 'error');
                    updateStatus('Failed to fetch user assignments', 'error');
                } else {
                    log(`‚úÖ Found ${data?.length || 0} user assignments`, 'success');
                    data.forEach((assign, index) => {
                        log(`  ${index + 1}. User: ${assign.user_id} -> Project: ${assign.project_assign}`);
                    });
                    updateStatus(`Found ${data?.length || 0} user assignments`, 'success');
                }
            } catch (error) {
                log(`‚ùå Check failed: ${error.message}`, 'error');
                updateStatus('Check failed', 'error');
            }
        };

        window.forceExpiryReminders = async function() {
            updateStatus('Forcing expiry reminders...', 'info');
            log('üöÄ Forcing expiry reminders for all licenses...');
            
            try {
                // This would normally call your notification store function
                // For now, we'll simulate it by checking for expiring licenses
                const today = new Date().toISOString().slice(0, 10);
                
                const { data: expiringSerials, error } = await supabase
                    .from('license_serials')
                    .select(`
                        *,
                        licenses!inner(
                            created_by, 
                            item_description, 
                            project_assign
                        )
                    `)
                    .lte('end_date', new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toISOString().slice(0, 10)); // Next 30 days

                if (error) {
                    log(`‚ùå Error fetching expiring serials: ${error.message}`, 'error');
                    updateStatus('Failed to fetch expiring licenses', 'error');
                } else {
                    log(`‚úÖ Found ${data?.length || 0} licenses expiring in next 30 days`, 'success');
                    data.forEach((serial, index) => {
                        const daysUntil = Math.ceil((new Date(serial.end_date) - new Date()) / (1000 * 60 * 60 * 24));
                        log(`  ${index + 1}. ${serial.serial_or_contract} - ${serial.licenses.item_description}`);
                        log(`     Expires in: ${daysUntil} days, Project: ${serial.licenses.project_assign}`);
                    });
                    
                    // Send test notification for each expiring license
                    for (const serial of data || []) {
                        const daysUntil = Math.ceil((new Date(serial.end_date) - new Date()) / (1000 * 60 * 60 * 24));
                        const urgencyLevel = daysUntil <= 7 ? 'URGENT' : 'IMPORTANT';
                        const urgencyColor = daysUntil <= 7 ? '#dc3545' : '#fd7e14';
                        
                        await supabase.functions.invoke('send-email-notification', {
                            body: {
                                to: 'ayezinhtun9@gmail.com',
                                subject: `${urgencyLevel}: ${serial.serial_or_contract} expires in ${daysUntil} days`,
                                html: `
                                    <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto; background: #f8f9fa;">
                                        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 30px 20px; text-align: center;">
                                            <h1 style="color: white; margin: 0; font-size: 24px; font-weight: 600;">License Management System</h1>
                                            <p style="color: rgba(255,255,255,0.9); margin: 5px 0 0 0; font-size: 14px;">One Cloud Technology</p>
                                        </div>
                                        <div style="background: ${urgencyColor}; color: white; padding: 15px 20px; text-align: center; font-weight: 600; font-size: 16px; text-transform: uppercase; letter-spacing: 1px;">
                                            ${urgencyLevel} - ACTION REQUIRED
                                        </div>
                                        <div style="padding: 30px 20px; background: white; margin: 0 20px;">
                                            <h2 style="color: #dc3545; margin: 0 0 20px 0; font-size: 22px; font-weight: 600;">
                                                ‚ö†Ô∏è License Expiring Soon
                                            </h2>
                                            <p style="color: #666; font-size: 16px; line-height: 1.6; margin-bottom: 25px;">
                                                ${serial.serial_or_contract} for ${serial.licenses.item_description} expires in ${daysUntil} day(s).
                                            </p>
                                            <div style="background: #f8d7da; border: 1px solid #f5c6cb; padding: 20px; border-radius: 8px; margin: 25px 0;">
                                                <h4 style="margin: 0 0 10px 0; color: #721c24; font-size: 16px; font-weight: 600;">üìã Action Required:</h4>
                                                <ul style="margin: 0; padding-left: 20px; color: #721c24;">
                                                    <li>Review license details immediately</li>
                                                    <li>Contact vendor for renewal options</li>
                                                    <li>Update license information in system</li>
                                                    <li>Notify relevant team members</li>
                                                </ul>
                                            </div>
                                        </div>
                                        <div style="background: #343a40; color: white; padding: 25px 20px; text-align: center; margin: 0 20px;">
                                            <p style="margin: 0; font-size: 12px; color: #6c757d;">
                                                ¬© ${new Date().getFullYear()} One Cloud Technology. All rights reserved.
                                            </p>
                                        </div>
                                    </div>
                                `
                            }
                        });
                        
                        log(`üìß Sent notification for: ${serial.serial_or_contract}`, 'success');
                    }
                    
                    updateStatus(`Processed ${data?.length || 0} expiring licenses`, 'success');
                }
            } catch (error) {
                log(`‚ùå Force reminders failed: ${error.message}`, 'error');
                updateStatus('Force reminders failed', 'error');
            }
        };

        window.checkDatabaseStatus = async function() {
            updateStatus('Checking database status...', 'info');
            log('üìä Checking database status...');
            
            try {
                // Check licenses table
                const { data: licenses, error: licensesError } = await supabase
                    .from('licenses')
                    .select('count')
                    .single();

                // Check license_serials table
                const { data: serials, error: serialsError } = await supabase
                    .from('license_serials')
                    .select('count')
                    .single();

                // Check notifications table
                const { data: notifications, error: notifError } = await supabase
                    .from('notifications')
                    .select('count')
                    .single();

                // Check user_project_assignments table
                const { data: assignments, error: assignError } = await supabase
                    .from('user_project_assigns')
                    .select('count')
                    .single();

                log('üìä Database Table Status:', 'success');
                log(`  Licenses: ${licenses?.count || 0} records ${licensesError ? '(Error: ' + licensesError.message + ')' : ''}`);
                log(`  License Serials: ${serials?.count || 0} records ${serialsError ? '(Error: ' + serialsError.message + ')' : ''}`);
                log(`  Notifications: ${notifications?.count || 0} records ${notifError ? '(Error: ' + notifError.message + ')' : ''}`);
                log(`  User Assignments: ${assignments?.count || 0} records ${assignError ? '(Error: ' + assignError.message + ')' : ''}`);

                updateStatus('Database status check completed', 'success');
            } catch (error) {
                log(`‚ùå Database check failed: ${error.message}`, 'error');
                updateStatus('Database check failed', 'error');
            }
        };

        window.clearLog = function() {
            document.getElementById('log').innerHTML = 'Log cleared...';
            updateStatus('Log cleared', 'info');
        };

        // Initial status
        updateStatus('Test page loaded. Please update your Supabase credentials in the script.', 'info');
        log('üîß Test page loaded successfully');
        log('‚ö†Ô∏è Remember to update YOUR_SUPABASE_URL and YOUR_SUPABASE_ANON_KEY in the script');
    </script>
</body>
</html>
